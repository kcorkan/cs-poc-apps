<!DOCTYPE html>
<html>
<head>
    <title>PlanningApp</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Toolbox",{singleton:!0,loadProjects:function(fetchList){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:fetchList,limit:"Infinity"}).load({callback:function(records,operation){deferred.resolve(records)}}),deferred},getModelObject:function(name){var deffered=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:name,success:function(model){deffered.resolve(model)}}),deffered.promise},buildProjectPinBuildingBlockData:function(records,fieldName){var hashByObjectID=Toolbox.buildHashByField(records,"ObjectID"),pins=_.map(_.filter(records,function(r){return/^TECHNOLOGY AREA/.test(r.get("Name"))}),function(r){return r.get("ObjectID")}),projectsWithBuildingBlocks=Ext.Array.filter(records,function(record){return record.get(fieldName)&&record.get(fieldName).length>0}),data=Ext.Array.map(projectsWithBuildingBlocks,function(p){var path=Toolbox.getProjectPath(p,hashByObjectID),pathNames=Toolbox.getStringPath(path,hashByObjectID),pin=_.intersect(pins,path);return{Name:p.get("Name"),BuildingBlock:p.get(fieldName),ObjectID:p.get("ObjectID"),Ancestors:path,AncestorNames:pathNames,Pin:hashByObjectID[pin]}});return data},buildHashByField:function(records,field){var hash={};return Ext.Array.each(records,function(record){hash[record.get(field)]=record}),hash},buildCustomProjectData:function(records,customField){var hashByObjectID=Toolbox.buildHashByField(records,"ObjectID"),projectsWithBuildingBlocks=Ext.Array.filter(records,function(record){return record.get(customField)&&record.get(customField).length>0}),data=Ext.Array.map(projectsWithBuildingBlocks,function(p){var path=Toolbox.getProjectPath(p,hashByObjectID),stringPath=Toolbox.getStringPath(path,hashByObjectID);return{Name:p.get("Name"),BuildingBlock:p.get(customField),ObjectID:p.get("ObjectID"),Path:stringPath,Ancestors:path}});return data},getStringPath:function(path,hashByObjectID){var stringPath=_.map(path,function(p){return hashByObjectID[p].get("Name")||"--"});return stringPath},getProjectPath:function(projectRecord,projectHashByObjectID){for(var parent=projectRecord.get("Parent")&&projectRecord.get("Parent").ObjectID,path=[projectRecord.get("ObjectID")];parent;){var parentRecord=projectHashByObjectID[parent];parentRecord?(path.unshift(projectHashByObjectID[parent].get("ObjectID")),parent=parentRecord.get("Parent")&&parentRecord.get("Parent").ObjectID):parent=null}return path}});
                Ext.define("SummaryTemplate",{extend:"Ext.XTemplate",constructor:function(config){var templateConfig=["<tpl><table>","<thead>","<th>Platform/PIN</th>","<th>Quarter</th>","<th>Team Sprint Capacity</th>","</thead>","<tr>","<td>{Pin}</td>","<td>{Quarter}</td>","<td>{TeamSprintCapacity}</td>","</tr>","</table></tpl>"];return this.callParent(templateConfig)}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",parentTypePath:"portfolioitem/roadmap",planningQuarterField:"c_PlanningQuarter",parentFetch:["FormattedID","Name","ObjectID","Project"],projectFetchList:["ObjectID","Name","Parent"],buildingBlockField:"c_BuildingBlock",demandField:"c_TotalDemandVisitor",items:[{xtype:"container",itemId:"filterBox",layout:"hbox"},{xtype:"container",itemId:"summaryBox"},{xtype:"container",itemId:"gridBox"}],launch:function(){var projectFetchList=this.projectFetchList.concat([this.buildingBlockField]);Deft.Promise.all([Toolbox.loadProjects(projectFetchList)]).then({scope:this,success:function(results){this.buildingBlockData=Toolbox.buildProjectPinBuildingBlockData(results[0]),this._addComponents()},failure:function(message){Rally.ui.notify.Notifier.showError({message:"Error retrieving projects: "+message})}})},_addComponents:function(){this._addFilterComponent(),this._addSummaryComponent()},_addSummaryComponent:function(){console.log("inside summary component");var summary_tpl=Ext.create("SummaryTemplate");this.down("#summaryBox").tpl=summary_tpl,this._updateSummaryContainer()},_updateSummaryContainer:function(){var summary=this.down("#summaryBox");summary.update({Pin:this._getPlatformPin(),Quarter:this.down("#quarterComboBox")&&this.down("#quarterComboBox").getValue()||"None Selected",TeamSprintCapacity:this._getTeamSprintCapacity()})},_getTeamSprintCapacity:function(){return"200"},_getPlatformPin:function(){return this.getContext().getProject().Name},_addFilterComponent:function(){this.down("#filterBox").add({xtype:"rallyfieldvaluecombobox",itemId:"quarterComboBox",fieldLabel:"Planning Quarter:",labelAlign:"right",model:this.parentTypePath,field:this.planningQuarterField}),this.down("#filterBox").add({xtype:"rallyfieldvaluecombobox",itemId:"stateComboBox",fieldLabel:"State:",labelAlign:"right",multiSelect:!0,model:this.parentTypePath,field:"State"}),this.down("#stateComboBox").on("select",this._onSelect,this),this.down("#quarterComboBox").on("select",this._onSelect,this),this._displayGrid()},_getFilters:function(){var state=this.down("#stateComboBox").getValue(),quarter=this.down("#quarterComboBox").getValue(),stateFilters=null,quarterFilter=null;return state&&(stateFilters=_.map(state,function(s){return{property:"State",value:s||""}}),stateFilters=Rally.data.wsapi.Filter.or(stateFilters)),quarter&&(quarterFilter=Ext.create("Rally.data.wsapi.Filter",{property:this.planningQuarterField,value:quarter||""})),stateFilters&&quarterFilter?stateFilters.and(quarterFilter):stateFilters||quarterFilter||[]},_onSelect:function(cb){var grid=this.down("rallygrid"),store=grid.getStore(),filters=this._getFilters();store.clearFilter(!0),filters&&store.addFilter(filters,!0),store.load(),this._updateSummaryContainer()},_displayGrid:function(){this.down("#gridBox").removeAll(),this.down("dataGrid")&&this.down("dataGrid").destroy(),this._buildGrid()},_updateModels:function(store,records){Ext.Array.each(records,function(r){r.set("homeDemand",4),r.set("visitorDemand",4),r.set("totalDemand",8),r.set("buildingBlocks",[{team:"home",pin:"Home PIN",name:"BB1",amount:4},{team:"visiting",pin:"PIN1",name:"BB2",amount:3},{team:"visiting",pin:"PIN1",name:"BB3",amount:1}])})},_buildGrid:function(){var grid=this.down("#gridBox").add({xtype:"rallygrid",itemId:"dataGrid",storeConfig:{model:this.parentTypePath,fetch:this.parentFetch,autoLoad:!0,listeners:{load:this._updateModels,scope:this}},margin:25,columnCfgs:this._getColumnCfgs(),bulkEditConfig:{items:[{xtype:"examplebulkrecordmenuitem"}]},showRowActionsColumn:!0,plugins:[{ptype:"rowexpander",rowBodyTpl:'<div id="planning-{FormattedID}"> </div>'}]});grid.getView().on("expandbody",this._expandRowBody,this)},_expandRowBody:function(rowNode,record,expandRow,options){var ct=Ext.get(expandRow.querySelector("#planning-"+record.get("FormattedID"))),data=record.get("buildingBlocks");console.log("_expandRowBody",rowNode,record,expandRow,options,ct),ct.setHeight(200);var grid=ct.down("#planning-row-"+record.get("FormattedID"));grid&&(console.log("grid found",grid),grid.destroy()),Ext.create("Rally.ui.grid.Grid",{itemId:"planning-row-"+record.get("FormattedID"),store:Ext.create("Rally.data.custom.Store",{data:data,fields:["team","pin","name","amount"],groupField:"team",groupDir:"ASC",getGroupString:function(record){var team=record.get("team");return"home"===team?"Home Team":"Visiting Teams"}}),pageSize:data.length,showPagingToolbar:!1,hideHeaders:!0,features:[{ftype:"groupingsummary",groupHeaderTpl:"{name} ({rows.length})",startCollapsed:!1}],columnCfgs:[{dataIndex:"pin",text:"pin",flex:1},{dataIndex:"name",text:"name",flex:1},{dataIndex:"amount",text:"amount",editor:{xtype:"rallynumberfield",listeners:{change:function(x,y,z){console.log("nb",x,y,z,record)}}}}],renderTo:ct})},_getColumnCfgs:function(){return[{dataIndex:"FormattedID"},{dataIndex:"Name"},{dataIndex:"Project"},{xtype:"templatecolumn",text:"Total Demand",tpl:"{homeDemand} + {visitorDemand} = {totalDemand}"},{xtype:"templatecolumn",text:"Home Demand",tpl:"{homeDemand}"},{xtype:"templatecolumn",text:"Visitor Demand",tpl:"{visitorDemand}"},{dataIndex:"PlannedStartDate"},{dataIndex:"PlannedEndDate"}]}});
                Ext.define("Rally.ui.dialog.CustomChooserDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.customchooserdialog",height:400,width:600,layout:"fit",closable:!0,draggable:!0,config:{title:"Choose an Item",teamData:[],teamFields:[],multiple:!0,columns:[{text:"Name",dataIndex:"Name",flex:1},{text:"Building Block",dataIndex:"BuildingBlock"},{text:"Path",dataIndex:"Path",flex:3}],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemchosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this._destroyTooltip(),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemchosen",this,this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},_getProjectDataStore:function(){var currentTeam=this.currentTeam,showHomeTeam="Home"===this.showHomeTeam;console.log("_getProjectDataStore",this.showHomeTeam,showHomeTeam),console.log("HomeTeam",showHomeTeam,"currentTeam",currentTeam);var data=this.teamData;return Ext.create("Rally.data.custom.Store",{data:data,fields:this.teamFields,remoteFilter:!1})},buildGrid:function(){this.grid&&this.grid.destroy();var projectDataStore=this._getProjectDataStore(),selectionConfig={mode:this.multiple?"SIMPLE":"SINGLE",allowDeselect:!0};this.grid=Ext.create("Rally.ui.grid.Grid",Ext.Object.merge({columnCfgs:this.columns,enableEditing:!1,enableColumnHide:!1,enableColumnMove:!1,selModel:this.showRadioButtons||this.multiple?Ext.create("Rally.ui.selection.CheckboxModel",Ext.apply(selectionConfig,{enableKeyNav:!1,isRowSelectable:function(record){return!0}})):Ext.create("Ext.selection.RowModel",selectionConfig),showRowActionsColumn:!1,store:projectDataStore,viewConfig:{emptyText:Rally.ui.EmptyTextFactory.get("defaultText"),publishLoadMessages:!1,getRowClass:function(record){return Rally.util.Test.toBrowserTestCssClass("row",record.getId())}}},this.config.gridConfig)),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()},_addTooltip:function(){this._destroyTooltip(),this.tooltip=Ext.create("Rally.ui.tooltip.ToolTip",{target:this.grid.getEl(),html:"You don't have permission to edit this item.",delegate:".disabled-row",anchor:"top",showDelay:0,showOnClick:!0})},_destroyTooltip:function(){this.tooltip&&this.tooltip.destroy()},_getStoreConfig:function(){var storeConfig=_.cloneDeep(this.getInitialConfig().storeConfig);return this._getSearchTerms()&&(storeConfig.search=this._getSearchTerms()),storeConfig.filters=(storeConfig.filters||[]).concat(this.getStoreFilters()),storeConfig},_enableDoneButton:function(){this.down("#doneButton").setDisabled(this.selectionCache.length?!1:!0)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("ObjectID")===record.get("ObjectID")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1===index&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1!==index&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?(this.mon(this.grid,"load",this._onGridReady,this,{single:!0}),void 0):(this._onGridLoad(),this.center(),void 0):(this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0}),void 0)},_isArtifactEditable:function(record){return Rally.environment.getContext().getPermissions().isProjectEditor(record.get("Project"))},_onGridLoad:function(){var defaultSelection=Ext.Array.from(this.selectedRef||this.selectedRecords);if(defaultSelection.length){var selectedRecords=_.compact(_.map(defaultSelection,function(ref){var recordIndex=this.grid.getStore().find("_ref",ref);return recordIndex>=0?this.grid.getStore().getAt(recordIndex):null},this));selectedRecords.length&&this.grid.getSelectionModel().select(selectedRecords)}else{var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var recordIndex=store.find("_ref",record.get("_ref"));if(-1!==recordIndex){var storeRecord=store.getAt(recordIndex);records.push(storeRecord)}}),records.length&&this.grid.getSelectionModel().select(records)}this._addTooltip(),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)},_search:function(){var terms=RegExp(this._getSearchTerms(),"gi");this.grid.getStore().filterBy(function(record){return terms?terms.test(record.get("Name"))||terms.test(record.get("Path"))||terms.test(record.get("c_BuildingBlock")):!0})},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}});
                Ext.define("ExampleRecordMenuItem",{extend:"Rally.ui.menu.item.RecordMenuItem",alias:"widget.examplerecordmenuitem",clickHideDelay:1,config:{record:void 0,handler:function(){var currentTeam=this.record.get("Project").ObjectID;console.log("Inside handler function teamFields",this.teamFields,"currentTeam",currentTeam,"teamData=",this.teamData);var dlg=Ext.create("Rally.ui.dialog.CustomChooserDialog",{teamFields:this.teamFields,showHomeTeam:this.showHomeTeam,currentTeam:currentTeam,teamData:this.teamData,listeners:{scope:this,itemchosen:function(dlg,selectedTeam){console.log("team chosen",selectedTeam,this.subFeatureModel)}}});dlg.show(),console.log("after dialog show")},predicate:function(record){return!0},text:"Example Record Menu Item..."},constructor:function(config){this.initConfig(config),this.callParent(arguments)},createSubFeatures:function(record,teams,subfeatureModel){console.log("createSubFeatures record",record,"teams",teams,"subfeatureModel",subfeatureModel);var promises=[],me=this;Ext.Array.each(teams,function(team){var newObject=Ext.create(subfeatureModel,{Name:record.get("Name")+": "+team.get("BuildingBlock"),c_ProjectType:record.get("c_ProjectType"),Parent:record.get("_ref"),Project:"/project/"+team.get("ObjectID")});promises.push(function(){return me._saveObject(newObject)})}),Deft.Chain.sequence(promises).then({scope:this,success:this.onSuccess,failure:this.onError})},_saveObject:function(obj){var deffered=Ext.create("Deft.Deferred");return obj.save({callback:function(record,operation){console.log("newObjectSaveCallback",record,operation),operation.wasSuccessful()?deffered.resolve(record):deffered.reject(operation)}}),deffered.promise}});
                Ext.override(Rally.ui.menu.DefaultRecordMenu,{onSuccess:Ext.emptyFn,onError:Ext.emptyFn,_getMenuItems:function(){var record=this.getRecord(),items=[],popoverPlacement=this.popoverPlacement||Rally.ui.popover.Popover.DEFAULT_PLACEMENT;return items.push({xtype:"examplerecordmenuitem",view:this.view,record:record,text:"Add HomeBuildingBlock",teamData:this.teamData,teamFields:this.teamFields,subFeatureModel:this.subFeatureModel,showHomeTeam:"Home",onSuccess:this.onSuccess,onError:this.onError}),items.push({xtype:"examplerecordmenuitem",view:this.view,record:record,text:"Add VisitorBuildingBlock",teamData:this.teamData,teamFields:this.teamFields,subFeatureModel:this.subFeatureModel,showHomeTeam:"Visitor",onSuccess:this.onSuccess,onError:this.onError}),items}});

            Rally.launchApp('CustomApp', {
                name:"PlanningApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
